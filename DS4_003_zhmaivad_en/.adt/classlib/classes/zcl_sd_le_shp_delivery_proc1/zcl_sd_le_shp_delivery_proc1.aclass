CLASS zcl_sd_le_shp_delivery_proc1 DEFINITION
  PUBLIC
  FINAL
  CREATE PUBLIC.

  PUBLIC SECTION.
    INTERFACES if_badi_interface.
    INTERFACES if_ex_le_shp_delivery_proc.
ENDCLASS.



CLASS ZCL_SD_LE_SHP_DELIVERY_PROC1 IMPLEMENTATION.


  METHOD if_ex_le_shp_delivery_proc~delivery_final_check.
    " -----------------------------------------------------------------------
    "  R E V I S I O N   H I S T O R Y                                     -
    " -----------------------------------------------------------------------
    " AUTHOR       | DATE       | CHANGE NUMBER & DESCRIPTION              -
    "              |            | TRANSPORT REQUESTS                       -
    " -----------------------------------------------------------------------
    " ZHMAIVAD     | 09.10.2023 | 24101     : Feature - [PFE build] CNC ST -
    "              |            | DS4K964057                               -
    " ----------------------------------------------------------------------*
    RETURN.
  ENDMETHOD.


  METHOD if_ex_le_shp_delivery_proc~change_delivery_header.
    " -----------------------------------------------------------------------
    "  R E V I S I O N   H I S T O R Y                                     -
    " -----------------------------------------------------------------------
    " AUTHOR       | DATE       | CHANGE NUMBER & DESCRIPTION              -
    "              |            | TRANSPORT REQUESTS                       -
    " -----------------------------------------------------------------------
    " ZHMAIVAD     | 09.10.2023 | 24101     : Feature - [PFE build] CNC ST -
    "              |            | DS4K964057                               -
    " ----------------------------------------------------------------------*
    RETURN.
  ENDMETHOD.


  METHOD if_ex_le_shp_delivery_proc~change_delivery_item.
    " -----------------------------------------------------------------------
    "  R E V I S I O N   H I S T O R Y                                     -
    " -----------------------------------------------------------------------
    " AUTHOR       | DATE       | CHANGE NUMBER & DESCRIPTION              -
    "              |            | TRANSPORT REQUESTS                       -
    " -----------------------------------------------------------------------
    " ZHMAIVAD     | 09.10.2023 | 24101     : Feature - [PFE build] CNC ST -
    "              |            | DS4K964057                               -
    " ----------------------------------------------------------------------*
    RETURN.
  ENDMETHOD.


  METHOD if_ex_le_shp_delivery_proc~change_fcode_attributes.
    " -----------------------------------------------------------------------
    "  R E V I S I O N   H I S T O R Y                                     -
    " -----------------------------------------------------------------------
    " AUTHOR       | DATE       | CHANGE NUMBER & DESCRIPTION              -
    "              |            | TRANSPORT REQUESTS                       -
    " -----------------------------------------------------------------------
    " ZHMAIVAD     | 09.10.2023 | 24101     : Feature - [PFE build] CNC ST -
    "              |            | DS4K964057                               -
    " ----------------------------------------------------------------------*
    RETURN.
  ENDMETHOD.


  METHOD if_ex_le_shp_delivery_proc~change_field_attributes.
    " -----------------------------------------------------------------------
    "  R E V I S I O N   H I S T O R Y                                     -
    " -----------------------------------------------------------------------
    " AUTHOR       | DATE       | CHANGE NUMBER & DESCRIPTION              -
    "              |            | TRANSPORT REQUESTS                       -
    " -----------------------------------------------------------------------
    " ZHMAIVAD     | 09.10.2023 | 24101     : Feature - [PFE build] CNC ST -
    "              |            | DS4K964057                               -
    " ----------------------------------------------------------------------*
    RETURN.
  ENDMETHOD.


  METHOD if_ex_le_shp_delivery_proc~check_item_deletion.
    " -----------------------------------------------------------------------
    "  R E V I S I O N   H I S T O R Y                                     -
    " -----------------------------------------------------------------------
    " AUTHOR       | DATE       | CHANGE NUMBER & DESCRIPTION              -
    "              |            | TRANSPORT REQUESTS                       -
    " -----------------------------------------------------------------------
    " ZHMAIVAD     | 09.10.2023 | 24101     : Feature - [PFE build] CNC ST -
    "              |            | DS4K964057                               -
    " ----------------------------------------------------------------------*
    RETURN.
  ENDMETHOD.


  METHOD if_ex_le_shp_delivery_proc~delivery_deletion.
    " -----------------------------------------------------------------------
    "  R E V I S I O N   H I S T O R Y                                     -
    " -----------------------------------------------------------------------
    " AUTHOR       | DATE       | CHANGE NUMBER & DESCRIPTION              -
    "              |            | TRANSPORT REQUESTS                       -
    " -----------------------------------------------------------------------
    " ZHMAIVAD     | 09.10.2023 | 24101     : Feature - [PFE build] CNC ST -
    "              |            | DS4K964057                               -
    " ----------------------------------------------------------------------*
    RETURN.
  ENDMETHOD.


  METHOD if_ex_le_shp_delivery_proc~document_number_publish.
    " -----------------------------------------------------------------------
    "  R E V I S I O N   H I S T O R Y                                     -
    " -----------------------------------------------------------------------
    " AUTHOR       | DATE       | CHANGE NUMBER & DESCRIPTION              -
    "              |            | TRANSPORT REQUESTS                       -
    " -----------------------------------------------------------------------
    " ZHMAIVAD     | 09.10.2023 | 24101     : Feature - [PFE build] CNC ST -
    "              |            | DS4K964057                               -
    " ----------------------------------------------------------------------*
    RETURN.
  ENDMETHOD.


  METHOD if_ex_le_shp_delivery_proc~fill_delivery_header.
    " -----------------------------------------------------------------------
    "  R E V I S I O N   H I S T O R Y                                     -
    " -----------------------------------------------------------------------
    " AUTHOR       | DATE       | CHANGE NUMBER & DESCRIPTION              -
    "              |            | TRANSPORT REQUESTS                       -
    " -----------------------------------------------------------------------
    " ZHMAIVAD     | 09.10.2023 | 24101     : Feature - [PFE build] CNC ST -
    "              |            | DS4K964057                               -
    " ----------------------------------------------------------------------*
    RETURN.
  ENDMETHOD.


  METHOD if_ex_le_shp_delivery_proc~fill_delivery_item.
    " -----------------------------------------------------------------------
    "  R E V I S I O N   H I S T O R Y                                     -
    " -----------------------------------------------------------------------
    " AUTHOR       | DATE       | CHANGE NUMBER & DESCRIPTION              -
    "              |            | TRANSPORT REQUESTS                       -
    " -----------------------------------------------------------------------
    " ZHMAIVAD     | 09.10.2023 | 24101     : Feature - [PFE build] CNC ST -
    "              |            | DS4K964057                               -
    " ----------------------------------------------------------------------*
    RETURN.
  ENDMETHOD.


  METHOD if_ex_le_shp_delivery_proc~initialize_delivery.
    " -----------------------------------------------------------------------
    "  R E V I S I O N   H I S T O R Y                                     -
    " -----------------------------------------------------------------------
    " AUTHOR       | DATE       | CHANGE NUMBER & DESCRIPTION              -
    "              |            | TRANSPORT REQUESTS                       -
    " -----------------------------------------------------------------------
    " ZHMAIVAD     | 09.10.2023 | 24101     : Feature - [PFE build] CNC ST -
    "              |            | DS4K964057                               -
    " ----------------------------------------------------------------------*
    RETURN.
  ENDMETHOD.


  METHOD if_ex_le_shp_delivery_proc~item_deletion.
    " -----------------------------------------------------------------------
    "  R E V I S I O N   H I S T O R Y                                     -
    " -----------------------------------------------------------------------
    " AUTHOR       | DATE       | CHANGE NUMBER & DESCRIPTION              -
    "              |            | TRANSPORT REQUESTS                       -
    " -----------------------------------------------------------------------
    " ZHMAIVAD     | 09.10.2023 | 24101     : Feature - [PFE build] CNC ST -
    "              |            | DS4K964057                               -
    " -----------------------------------------------------------------------

    RETURN.
  ENDMETHOD.


  METHOD if_ex_le_shp_delivery_proc~publish_delivery_item.
    " -----------------------------------------------------------------------
    "  R E V I S I O N   H I S T O R Y                                     -
    " -----------------------------------------------------------------------
    " AUTHOR       | DATE       | CHANGE NUMBER & DESCRIPTION              -
    "              |            | TRANSPORT REQUESTS                       -
    " -----------------------------------------------------------------------
    " ZHMAIVAD     | 09.10.2023 | 24101     : Feature - [PFE build] CNC ST -
    "              |            | DS4K964057                               -
    " ----------------------------------------------------------------------*
    RETURN.
  ENDMETHOD.


  METHOD if_ex_le_shp_delivery_proc~read_delivery.
    " -----------------------------------------------------------------------
    "  R E V I S I O N   H I S T O R Y                                     -
    " -----------------------------------------------------------------------
    " AUTHOR       | DATE       | CHANGE NUMBER & DESCRIPTION              -
    "              |            | TRANSPORT REQUESTS                       -
    " -----------------------------------------------------------------------
    " ZHMAIVAD     | 09.10.2023 | 24101     : Feature - [PFE build] CNC ST -
    "              |            | DS4K964057                               -
    " ----------------------------------------------------------------------*
    RETURN.
  ENDMETHOD.


  METHOD if_ex_le_shp_delivery_proc~save_and_publish_before_output.
    " -----------------------------------------------------------------------
    "  R E V I S I O N   H I S T O R Y                                     -
    " -----------------------------------------------------------------------
    " AUTHOR       | DATE       | CHANGE NUMBER & DESCRIPTION              -
    "              |            | TRANSPORT REQUESTS                       -
    " -----------------------------------------------------------------------
    " ZHMAIVAD     | 09.10.2023 | 24101     : Feature - [PFE build] CNC ST -
    "              |            | DS4K964057                               -
    " ----------------------------------------------------------------------*
    " -----------------------------------------------------------------------
    "  R E V I S I O N   H I S T O R Y                                     -
    " -----------------------------------------------------------------------
    " AUTHOR       | DATE       | CHANGE NUMBER & DESCRIPTION              -
    "              |            | TRANSPORT REQUESTS                       -
    " -----------------------------------------------------------------------

    CONSTANTS lc_outbound_delivery        TYPE vbtyp  VALUE 'J'.
    CONSTANTS lc_inbound_delivery         TYPE vbtyp  VALUE '7'.
    CONSTANTS lc_create                   TYPE trtyp  VALUE 'H'.
    CONSTANTS lc_update                   TYPE trtyp  VALUE 'V'.
    CONSTANTS lc_goods_movement_vbfa_next TYPE vbtypl VALUE 'R'.

    DATA lv_status TYPE zcl_sd_sto_status_update=>gtyp_status.

    CONSTANTS:
      BEGIN OF lc_multiship_idoc,
        blank    TYPE zsd_multiship_flag_wms VALUE '',
        multiple TYPE zsd_multiship_flag_wms VALUE 'M',
        final    TYPE zsd_multiship_flag_wms VALUE 'F',
      END OF lc_multiship_idoc.

    CHECK if_trtyp = lc_create OR if_trtyp = lc_update.
    DATA(lt_multiship_pgi_params) = zcl_sd_sto_status_update=>get_buffer_data_shared( ).

    IF it_xlips IS NOT INITIAL.
      SELECT purchaseorder, zz1_zorderreason_pdh
        INTO TABLE @DATA(lt_zorderreason_pdh)
        FROM i_purchaseorderapi01
        FOR ALL ENTRIES IN @it_xlips
        WHERE purchaseorder = @it_xlips-vgbel.

      IF sy-subrc <> 0.
        RETURN.
      ENDIF.
    ENDIF.

    LOOP AT it_xlikp ASSIGNING FIELD-SYMBOL(<ls_xlikp>).
      LOOP AT it_xlips ASSIGNING FIELD-SYMBOL(<ls_lips>) WHERE vbeln = <ls_xlikp>-vbeln. "#EC CI_NESTED
        FINAL(lv_zorderreason_pdh) = VALUE #( lt_zorderreason_pdh[
                                                  purchaseorder = <ls_lips>-vgbel ]-zz1_zorderreason_pdh OPTIONAL ).
        IF lv_zorderreason_pdh NOT IN zcl_sd_sto_status_update=>gs_hm_data-order_reason_range.
          CONTINUE.
        ENDIF.

        CASE <ls_xlikp>-vbtyp.
          WHEN lc_outbound_delivery.
            TRY.
                IF line_exists( it_xvbfa[ vbelv = <ls_lips>-vbeln posnv = <ls_lips>-posnr vbtyp_n = lc_goods_movement_vbfa_next ] ).
                  FINAL(lv_multiship_flag_wms) = VALUE #( lt_multiship_pgi_params[
                                                              vbeln = <ls_xlikp>-vbeln ]-multiship_flag_wms DEFAULT lc_multiship_idoc-blank ).
                  IF lv_multiship_flag_wms = lc_multiship_idoc-blank OR lv_multiship_flag_wms = lc_multiship_idoc-final.
                    lv_status = zcl_sd_sto_status_update=>gc_sto_status-shipped.
                  ENDIF.
                ENDIF.
              CATCH cx_sy_itab_line_not_found.
                RETURN.
            ENDTRY.
          WHEN lc_inbound_delivery.
            IF line_exists( it_xvbfa[ vbelv = <ls_lips>-vbeln posnv = <ls_lips>-posnr vbtyp_n = lc_goods_movement_vbfa_next ] ).
              lv_status = zcl_sd_sto_status_update=>gc_sto_status-received.
            ENDIF.
        ENDCASE.

        IF lv_status IS NOT INITIAL.
          DELETE lt_multiship_pgi_params WHERE vbeln = <ls_xlikp>-vbeln.
          APPEND VALUE #( vbeln  = <ls_lips>-vbeln
                          posnr  = <ls_lips>-posnr
                          vgbel  = <ls_lips>-vgbel
                          vgpos  = <ls_lips>-vgpos
                          status = zcl_sd_sto_status_update=>gc_sto_status-shipped ) TO lt_multiship_pgi_params.
          zcl_sd_sto_status_update=>set_buffer_data_shared( lt_multiship_pgi_params  ).
          zcl_sd_sto_status_update=>set_text_po_item( iv_po_number = <ls_lips>-vgbel
                                                      iv_po_item   = <ls_lips>-vgpos+1(5)
                                                      iv_status    = lv_status ).
        ENDIF.
      ENDLOOP.
    ENDLOOP.
  ENDMETHOD.


  METHOD if_ex_le_shp_delivery_proc~save_and_publish_document.
    " -----------------------------------------------------------------------
    "  R E V I S I O N   H I S T O R Y                                     -
    " -----------------------------------------------------------------------
    " AUTHOR       | DATE       | CHANGE NUMBER & DESCRIPTION              -
    "              |            | TRANSPORT REQUESTS                       -
    " -----------------------------------------------------------------------
    " ZHMAIVAD     | 09.10.2023 | 24101     : Feature - [PFE build] CNC ST -
    "              |            | DS4K964057                               -
    " ----------------------------------------------------------------------*
    RETURN.
  ENDMETHOD.


  METHOD if_ex_le_shp_delivery_proc~save_document_prepare.
    " -----------------------------------------------------------------------
    "  R E V I S I O N   H I S T O R Y                                     -
    " -----------------------------------------------------------------------
    " AUTHOR       | DATE       | CHANGE NUMBER & DESCRIPTION              -
    "              |            | TRANSPORT REQUESTS                       -
    " -----------------------------------------------------------------------
    " ZHMAIVAD     | 09.10.2023 | 24101     : Feature - [PFE build] CNC ST -
    "              |            | DS4K964057                               -
    " ----------------------------------------------------------------------*
    RETURN.
  ENDMETHOD.
ENDCLASS.